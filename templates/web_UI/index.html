<!doctype html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.108.0">
  <title>Sensorhub 入库测试</title>
  {% csrf_token %}

  <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/sign-in/">

{% comment %} <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet"> {% endcomment %}
<link href="{% static 'web_UI_static/assets/dist/css/bootstrap.min.css' %}" rel="stylesheet">

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    .b-example-divider {
      height: 3rem;
      background-color: rgba(0, 0, 0, .1);
      border: solid rgba(0, 0, 0, .15);
      border-width: 1px 0;
      box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
    }

    .b-example-vr {
      flex-shrink: 0;
      width: 1.5rem;
      height: 100vh;
    }

    .bi {
      vertical-align: -.125em;
      fill: currentColor;
    }

    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333;
    }
    li {
      float: left;
    }
    li a {
      display: block;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }
    li a:hover {
      background-color: #111;
    }
    .page {
      display: none;
    }
    .active {
      display: block;
    }

    .checkbox-container {
      display: flex;
      justify-content: space-between;
      max-width: 300px;
    }
  </style>

  <!-- Custom styles for this template -->
  <link href="{% static 'web_UI_static/sign-in.css' %}" rel="stylesheet">
</head>
<body class="text-center">
  <div class="top-nav">
    <ul>
        <li><a href="">首页</a></li>
        <!-- <li><a href="javascript:void(0)" id="openModal">历史测试记录</a></li> -->
        <li><a href="#" id="dynamicLink">测试记录</a></li>
    </ul>
  </div>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <p>历史测试记录</p>
      <table id="history_table">
        <colgroup>
          <col style="width: 40%;">
          <col style="width: 40%;">
          <col style="width: 20%;">
        </colgroup>
        <thead>
          <tr>
            <th>完成时间</th>
            <th>SN号</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>2023-4-28 15:21:43</td>
            <td>77</td>
            <td><a href="{% static 'web_UI_static/assets/test.html' %}">查看</a></td>
            <td> </td>  
          </tr>
          <tr>
            <td>2023-4-28 15:52:29</td>
            <td>23</td>
            <td><a href="file:///C:/Users/jerry.han/Desktop/SH_11_12_20230314_171643/index.html">查看</a></td>
            <td> </td>
          </tr>
          <tr>
            <td>2023-5-6 11:40:46</td>
            <td>11_22</td>
            <td><a href="file:///C:/Users/jerry.han/Desktop/SH_11_12_20230314_171643/index.html">查看</a></td>
            <td> </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
<div id="index" class="content">
<div class="left-column">
  <main class="form-signin w-100 m-auto">
    <form>   
      <img class="mb-4" src="{% static 'web_UI_static/assets/brand/Logo.png' %}" alt="" width="72" height="72">
      <h1 class="h3 mb-3 fw-normal">Sensorhub 入库测试</h1>
      <div class="form-floating">
        <input type="" class="form-control" id="string_Input_SN" placeholder="***">
        <label for="floatingInput">请输入Sensorhub SN号</label>
      </div>
      <div class="form-floating">
        <input type="" class="form-control" id="string_result" placeholder="***">
        <label for="floatingPassword">启动状态</label>
      </div>
      <!-- <div class="checkbox-container"> -->
        <label style="display: block;"><input type="checkbox" id="all" onchange="checkAll();" checked> 全部</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分1" onchange="uncheckAll();"> sensorhub连接测试</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分2" onchange="uncheckAll();"> sensorhub固件检查与升级</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分3" onchange="uncheckAll();"> isp固件检查与升级</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分4" onchange="uncheckAll();"> 相机api_cmd检测</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分5" onchange="uncheckAll();"> FPGA信号检测</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分6" onchange="uncheckAll();"> 扣板上下电检测</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分7" onchange="uncheckAll();"> testdemo检测</label>
        <label style="display: block;"><input type="checkbox" class="partial" value="部分8" onchange="uncheckAll();"> emc_monitor检测</label>
      <!-- </div> -->
      <button class="w-100 btn btn-lg btn-primary" id="btn" onclick="start()" type="button">开始测试</button>
      <p class="mt-5 mb-3 text-muted">&copy; BUILD BY MOMENTA/2023.3.10  <img class="mb-4" src="{% static 'web_UI_static/assets/brand/mo.png' %}" alt="" width="60" height="10"></p>
    </form>
  </main>
</div>

<div class="right-column">
  <p id="title_text"></p>
  <p id="cur_step">Waiting...</p>
  <p>
    <progress max="8" value="0" id="progressBar"></progress>
  </p>
  <table id="result_table">
    <colgroup>
      <col style="width: 25%;">
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 40%;">
    </colgroup>
    <thead>
      <tr>
        <th>完成时间</th>
        <th>测试用例</th>
        <th>测试结果</th>
        <th>备注</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>等待中</td>
        <td>样例1</td>
        <td> </td>
        <td> </td>
      </tr>
    </tbody>
  </table>
</div>
</div>
<div id="history">
</div>

<script>
  const currentIP = "10.8.241.178";
  const socket = new WebSocket('ws://10.8.241.178:19799');
	var btn=document.getElementById("btn");
	var input_SN=document.getElementById("string_Input_SN");
	var output_res=document.getElementById("string_result");
  var current_step = document.getElementById('cur_step');
  var tableBody = document.querySelector("#result_table tbody");
  var progressBar = document.getElementById("progressBar");
  const allCheckbox = document.getElementById("all");
  const partialCheckboxes = document.getElementsByClassName("partial");
  var titleText = "测试未启动";
  var resultPort = "http://10.8.241.178:";
  document.getElementById("title_text").innerText=titleText;

  //socket数据传输相关
  socket.onopen = function() {
    console.log('连接成功')
    socket.send('unique confirm')
  }
  
  socket.addEventListener('message', (event) => { // 添加消息监听器
    var data = JSON.parse(event.data)
    if(Object.keys(data).length==1){
      resultPort = resultPort + data["result_port"]
      console.log(resultPort)
      document.getElementById("dynamicLink").href = resultPort;
    }
    if(Object.keys(data).length==3){
      current_step.textContent = data["cur_step"] + ": " + data["remark"]; 
      progressBar.value = data["step_id"]
    }
    if(Object.keys(data).length==5){
      var edit_cells = document.querySelectorAll("#result_table tbody tr:nth-child("+data["step_id"]+") td")
      edit_cells[0].textContent = data["log_time"]
      edit_cells[1].textContent = data["test_name"]
      edit_cells[2].textContent = data["result_status"]
      if(data["result_status"]=="success"){
        edit_cells[2].style.color = "green"
      }
      else{
        edit_cells[2].style.color = "red"
      }
      edit_cells[3].textContent = data["result_remark"]
    }
  });

  //表格控制
  for(var i=0;i<7;i++) {
    var newRow = document.createElement("tr");
    var cell1 = document.createElement("td");
    var cell2 = document.createElement("td");
    var cell3 = document.createElement("td");
    var cell4 = document.createElement("td");

    // 设置单元格文本内容（这里以i作为示例）
    cell1.textContent = "等待中"
    cell2.textContent = "样例"+(i+2);
    cell3.textContent = "";
    cell4.textContent = "";
    newRow.appendChild(cell1);
    newRow.appendChild(cell2);
    newRow.appendChild(cell3);
    newRow.appendChild(cell4);

    // 将新行添加到表格的tbody中
    tableBody.appendChild(newRow);
  }

  function setTable(){

  };

  //网页初始化
  window.onload = (event) =>{
    console.log('Page Loaded');
  };

  // 从cookie中获取CSRF令牌
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // 判断这个cookie是否是我们要找的cookie（name=csrfmiddlewaretoken）
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }

   //开始按钮
  async function start()
  {
    console.log("start",input_SN.value)
    output_res.value= "成功启动";
    var test_type= "";
    for (let i = 0; i < partialCheckboxes.length; i++) {
      if (partialCheckboxes[i].checked) {
        test_type=test_type+(i+1);
        titleText="【自定义测试】 当前进度：";
        document.getElementById("title_text").innerText=titleText;
      }
    }
    if(test_type==""){
      test_type="0";
      titleText="【全流程测试】 当前进度：";
      document.getElementById("title_text").innerText=titleText;
    }
    HTTP_POST(input_SN.value,test_type);
  }

  function HTTP_POST(sn_value,test_type){
    var httpRequest = new XMLHttpRequest();//第一步：创建需要的对象
    
    httpRequest.onreadystatechange = function () {
      console.log("发送成功等请求。。。")
        if (httpRequest.readyState == 4 && httpRequest.status == 200) {//验证请求是否发送成功
            console.log("发送成功等请求")
        var json = httpRequest.responseText;//获取到服务端返回的数据
            console.log(json);
            output_res.value= "测试流程已结束";
        }
    };
    
    httpRequest.open('POST', '{% url "my_view" %}', true); //第二步：打开连接
    httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");//设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）
    httpRequest.setRequestHeader("X-CSRFToken", getCookie('csrftoken')) // 设置请求头X-CSRFToken的值为CSRF令牌
    var obj = { SN:sn_value, TestType:test_type };
    httpRequest.send(JSON.stringify(obj));//发送请求 将json写入send中
  }	

{% comment %} 
  function HTTP_POST(sn_value,test_type){
    var httpRequest = new XMLHttpRequest();//第一步：创建需要的对象
    httpRequest.open('POST', 'http://10.9.61.37:29799/', true); //第二步：打开连接
    httpRequest.setRequestHeader("Content-type","multipart/form-data; boundary=----WebKitFormBoundaryypzmvcUdKsqJRGVn" );//设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）
    var obj = { SN:sn_value, TestType:test_type };
    httpRequest.send(JSON.stringify(obj));//发送请求 将json写入send中
    httpRequest.onreadystatechange = function () {
      console.log("发送成功等请求。。。")
        if (httpRequest.readyState == 4 && httpRequest.status == 200) {//验证请求是否发送成功
            console.log("发送成功等请求")
        var json = httpRequest.responseText;//获取到服务端返回的数据
            console.log(json);
            output_res.value= "测试流程已结束";
        }
    };
  }	 {% endcomment %}
  document.getElementById('openModal').addEventListener('click', function() {
    document.getElementById('myModal').style.display = 'block';
  });

  document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('myModal').style.display = 'none';
  });

  window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('myModal')) {
      document.getElementById('myModal').style.display = 'none';
    }
  });

  function checkAll() {
    if (allCheckbox.checked) {
      for (let i = 0; i < partialCheckboxes.length; i++) {
          partialCheckboxes[i].checked = false;
      }
    }
  }

  function uncheckAll() {
    for (let i = 0; i < partialCheckboxes.length; i++) {
      if (partialCheckboxes[i].checked) {
        allCheckbox.checked = false;
        return;
      }
    }
    allCheckbox.checked = true;
  }

</script>
    
</body>
</html>
